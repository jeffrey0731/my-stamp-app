<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>印章大师 - 在线抠章工具</title>
    <!-- 引入 Tailwind CSS 用于快速布局美化 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 简单的加载动画 */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc2626;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 透明背景网格 */
        .checkerboard {
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                              linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans selection:bg-red-100 min-h-screen flex flex-col">

    <!-- 顶部导航 -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-red-600 text-white p-1.5 rounded-lg">
                    <!-- 魔术棒图标 -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-gray-900">印章大师 <span class="text-gray-400 font-normal text-sm ml-1">HTML单文件版</span></h1>
            </div>
            <div class="text-xs text-gray-500 hidden sm:block">
                安全隐私：纯前端运行，图片不上传服务器
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 flex-grow w-full">
        
        <!-- 上传区域 (初始显示) -->
        <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-2xl bg-white h-96 flex flex-col items-center justify-center cursor-pointer hover:border-red-400 hover:bg-red-50 transition-colors group relative overflow-hidden">
            <input type="file" id="file-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
            <div class="bg-red-100 p-4 rounded-full mb-4 group-hover:scale-110 transition-transform duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-700 mb-2">点击或拖拽上传印章图片</h2>
            <p class="text-gray-500">也支持 <kbd class="bg-gray-100 px-2 py-1 rounded border border-gray-300 text-xs font-mono">Ctrl + V</kbd> 直接粘贴截图</p>
        </div>

        <!-- 工作区 (初始隐藏) -->
        <div id="workspace" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 左侧：控制面板 -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        调节选项
                    </h3>
                    
                    <!-- 色彩模式 -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">印章色彩模式</label>
                        <div class="grid grid-cols-3 gap-2" id="color-mode-group">
                            <button data-mode="red" class="mode-btn py-2 px-3 rounded-md text-sm font-medium transition-all bg-red-600 text-white shadow-md">鲜艳红</button>
                            <button data-mode="blue" class="mode-btn py-2 px-3 rounded-md text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200">商务蓝</button>
                            <button data-mode="original" class="mode-btn py-2 px-3 rounded-md text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200">原色</button>
                        </div>
                    </div>

                    <!-- 容差滑块 -->
                    <div class="mb-6">
                        <div class="flex justify-between mb-1">
                            <label class="block text-sm font-medium text-gray-700">背景去除力度 (容差)</label>
                            <span id="threshold-val" class="text-sm text-gray-500">180</span>
                        </div>
                        <input type="range" id="threshold" min="100" max="250" value="180" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-600">
                    </div>

                    <!-- 浓度滑块 -->
                    <div class="mb-6">
                        <div class="flex justify-between mb-1">
                            <label class="block text-sm font-medium text-gray-700">印泥浓度</label>
                            <span id="intensity-val" class="text-sm text-gray-500">100%</span>
                        </div>
                        <input type="range" id="intensity" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-600">
                    </div>

                    <!-- 降噪开关 -->
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">智能降噪</label>
                        <button id="smoothness-btn" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-red-600">
                            <span id="smoothness-dot" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                        </button>
                    </div>
                </div>

                <button id="reset-btn" class="w-full flex items-center justify-center gap-2 py-3 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50 hover:text-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    重新上传
                </button>
            </div>

            <!-- 右侧：预览区 -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 最终效果 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="font-semibold text-gray-900">最终效果预览</h3>
                    </div>
                    
                    <div class="relative p-8 flex items-center justify-center bg-gray-100 min-h-[300px]">
                        <!-- 透明背景网格 -->
                        <div class="checkerboard absolute inset-0 opacity-50 pointer-events-none"></div>

                        <img id="result-img" class="relative z-10 max-w-full max-h-[400px] object-contain shadow-sm drop-shadow-xl" alt="处理结果">
                        
                        <div id="loading" class="hidden absolute z-20 flex items-center gap-2 bg-white px-4 py-2 rounded shadow">
                            <div class="spinner"></div> <span>处理中...</span>
                        </div>
                    </div>

                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end">
                        <button id="download-btn" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-2.5 rounded-lg font-medium shadow-md shadow-red-200 transition-all active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            下载透明 PNG
                        </button>
                    </div>
                </div>

                <!-- 原始图片预览 -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 opacity-75 hover:opacity-100 transition-opacity">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">原始图片</h4>
                    <div class="h-32 flex items-center justify-center bg-gray-50 rounded border border-gray-100 overflow-hidden">
                        <img id="original-preview" class="max-h-full max-w-full object-contain mix-blend-multiply" alt="Original">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 逻辑脚本 -->
    <script>
        // 状态变量
        let originalImageSrc = null;
        let settings = {
            threshold: 180,
            colorMode: 'red',
            intensity: 1.0,
            smoothness: true
        };

        // DOM 元素引用
        const uploadArea = document.getElementById('upload-area');
        const workspace = document.getElementById('workspace');
        const fileInput = document.getElementById('file-input');
        const originalPreview = document.getElementById('original-preview');
        const resultImg = document.getElementById('result-img');
        const loading = document.getElementById('loading');
        
        // 控件引用
        const thresholdInput = document.getElementById('threshold');
        const thresholdVal = document.getElementById('threshold-val');
        const intensityInput = document.getElementById('intensity');
        const intensityVal = document.getElementById('intensity-val');
        const smoothnessBtn = document.getElementById('smoothness-btn');
        const smoothnessDot = document.getElementById('smoothness-dot');
        const modeBtns = document.querySelectorAll('.mode-btn');
        const resetBtn = document.getElementById('reset-btn');
        const downloadBtn = document.getElementById('download-btn');

        // 初始化事件监听
        function init() {
            // 文件上传
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            
            // 拖拽支持
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('border-red-400'); });
            uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('border-red-400'); });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-red-400');
                if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
            });

            // 粘贴支持 (Ctrl+V)
            window.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        handleFile(items[i].getAsFile());
                    }
                }
            });

            // 控件事件
            thresholdInput.addEventListener('input', (e) => {
                settings.threshold = Number(e.target.value);
                thresholdVal.textContent = settings.threshold;
                scheduleProcess();
            });

            intensityInput.addEventListener('input', (e) => {
                settings.intensity = Number(e.target.value);
                intensityVal.textContent = (settings.intensity * 100).toFixed(0) + '%';
                scheduleProcess();
            });

            smoothnessBtn.addEventListener('click', () => {
                settings.smoothness = !settings.smoothness;
                // 更新UI
                if(settings.smoothness) {
                    smoothnessBtn.classList.replace('bg-gray-200', 'bg-red-600');
                    smoothnessDot.classList.replace('translate-x-1', 'translate-x-6');
                } else {
                    smoothnessBtn.classList.replace('bg-red-600', 'bg-gray-200');
                    smoothnessDot.classList.replace('translate-x-6', 'translate-x-1');
                }
                scheduleProcess();
            });

            modeBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    settings.colorMode = e.target.dataset.mode;
                    updateModeUI();
                    scheduleProcess();
                });
            });

            resetBtn.addEventListener('click', resetAll);
            downloadBtn.addEventListener('click', downloadImage);
        }

        function updateModeUI() {
            modeBtns.forEach(btn => {
                if (btn.dataset.mode === settings.colorMode) {
                    // 激活状态样式
                    btn.className = `mode-btn py-2 px-3 rounded-md text-sm font-medium transition-all text-white shadow-md ${settings.colorMode === 'blue' ? 'bg-blue-600' : (settings.colorMode === 'original' ? 'bg-gray-800' : 'bg-red-600')}`;
                } else {
                    // 非激活状态
                    btn.className = 'mode-btn py-2 px-3 rounded-md text-sm font-medium transition-all bg-gray-100 text-gray-600 hover:bg-gray-200';
                }
            });
        }

        // 处理文件加载
        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImageSrc = e.target.result;
                originalPreview.src = originalImageSrc;
                
                // 切换界面
                uploadArea.classList.add('hidden');
                workspace.classList.remove('hidden');
                
                // 开始第一次处理
                processImage();
            };
            reader.readAsDataURL(file);
        }

        // 防抖处理，避免滑块滑动时卡顿
        let processTimer = null;
        function scheduleProcess() {
            if (processTimer) clearTimeout(processTimer);
            loading.classList.remove('hidden'); // 显示加载中
            processTimer = setTimeout(processImage, 100);
        }

        // 核心算法：图像处理
        function processImage() {
            if (!originalImageSrc) return;

            const img = new Image();
            img.src = originalImageSrc;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // 限制最大尺寸以保证性能
                const MAX_SIZE = 2000;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_SIZE) {
                        height *= MAX_SIZE / width;
                        width = MAX_SIZE;
                    }
                } else {
                    if (height > MAX_SIZE) {
                        width *= MAX_SIZE / height;
                        height = MAX_SIZE;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;

                // 目标颜色定义
                const targetColors = {
                    red: { r: 230, g: 0, b: 20 },
                    blue: { r: 0, g: 50, b: 200 },
                    black: { r: 20, g: 20, b: 20 }
                };

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // 计算亮度
                    const brightness = (r + g + b) / 3;

                    // 1. 背景去除逻辑
                    if (brightness > settings.threshold) {
                        data[i + 3] = 0; // 设置为完全透明
                    } else {
                        // 2. 色彩重构逻辑
                        if (settings.colorMode !== 'original') {
                            // 反转亮度作为基础透明度（越黑的字，alpha越高）
                            let newAlpha = 255 - brightness;
                            
                            // 增加对比度，消除灰色边缘
                            newAlpha = newAlpha * 1.5;
                            if (newAlpha > 255) newAlpha = 255;
                            
                            // 应用浓度
                            newAlpha = newAlpha * settings.intensity;

                            // 降噪：过滤掉极淡的像素
                            if (settings.smoothness && newAlpha < 40) {
                                newAlpha = 0;
                            }

                            if (newAlpha > 0) {
                                const target = targetColors[settings.colorMode];
                                data[i] = target.r;
                                data[i + 1] = target.g;
                                data[i + 2] = target.b;
                                data[i + 3] = newAlpha;
                            } else {
                                data[i + 3] = 0;
                            }
                        } else {
                            // 原色模式：仅增强不透明度
                            if (data[i + 3] !== 0) {
                                data[i + 3] = Math.min(255, 255 * settings.intensity);
                            }
                        }
                    }
                }

                ctx.putImageData(imageData, 0, 0);
                resultImg.src = canvas.toDataURL('image/png');
                loading.classList.add('hidden'); // 隐藏加载中
            };
        }

        function downloadImage() {
            if (!resultImg.src) return;
            const link = document.createElement('a');
            link.download = `印章大师_${Date.now()}.png`;
            link.href = resultImg.src;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetAll() {
            originalImageSrc = null;
            fileInput.value = '';
            uploadArea.classList.remove('hidden');
            workspace.classList.add('hidden');
            // 重置设置到默认
            settings = { threshold: 180, colorMode: 'red', intensity: 1.0, smoothness: true };
            thresholdInput.value = 180; thresholdVal.textContent = 180;
            intensityInput.value = 1.0; intensityVal.textContent = "100%";
            smoothnessBtn.classList.replace('bg-gray-200', 'bg-red-600');
            smoothnessDot.classList.replace('translate-x-1', 'translate-x-6');
            updateModeUI();
        }

        // 启动
        init();
    </script>
</body>
</html>